#!/bin/bash

# Verify APK integrity
if ! zip -T "$APK" > /dev/null 2>&1; then
    echo "APK file $APK is corrupted or not a valid ZIP archive." > $CUR_TTY
    exit 1
fi

# Extract all files to /tmp directory
mkdir -p "$GAMEDIR/tmp"
echo "Extracting apk..." > $CUR_TTY
unzip "$APK" -d "$GAMEDIR/tmp"

# Move game.droid to $GAMEDIR
mv "$GAMEDIR/tmp/assets/game.droid" "$GAMEDIR/game.droid"

# Repack the contents of the /tmp directory into $GAMEDIR/game.apk
cd "$GAMEDIR/tmp"
echo "Repacking apk..." > $CUR_TTY
zip -r0 "$GAMEDIR/game.apk" ./*
cd $GAMEDIR

# Clean up the temporary directory
rm -rf "$GAMEDIR/tmp"